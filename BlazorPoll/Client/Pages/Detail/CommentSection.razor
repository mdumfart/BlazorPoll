@using BlazorPoll.Client.Services
@inject ICommentsService CommentsService
@inject IUserService UserService
@inject IJSRuntime JS

<section class="comment-section-wrapper">
    @if (Comments?.Data != null)
    {
        @foreach (var comment in Comments.Data)
        {
            <CommentComponent DisplayComment="@comment"/>
        }

        <div class="pagination-wrapper">
            <BlazorPager CurrentPage="@Comments.CurrentPage"
                         PageCount="@Comments.PageCount"
                         OnPageChanged="(async e => { _page = e; NotifyParentPageChanged(); })"
                         ShowFirstLast="false"
                         ShowPageNumbers="true"
                         VisiblePages="10"
                         FirstText="First"
                         LastText="Last"  />
        </div>
    }


    <EditForm Model="@Comment" OnValidSubmit="SubmitComment">
        <DataAnnotationsValidator/>
        <div class="input-group input-group-lg input-validation-wrapper create-comment-input-wrapper">
            <InputText class="form-control input-validate full-width" placeholder="Write a comment..." @bind-Value="Comment.Content"/>
            <div class="validation-message-wrapper">
                <ValidationMessage For="@(() => Comment.Content)"/>
            </div>
        </div>
        <button class="btn btn-primary button-send-comment">
            @if (IsLoading)
            {
                <Bounce Size="20px" Color="#fff" class="@(IsLoading ? "loading-visible" : "loading-invisible")"/>
            }
            else
            {
                <span class="@(!IsLoading ? "loading-visible" : "loading-invisible")">Submit comment</span>
            }
        </button>
    </EditForm>
</section>

@code {
    [Parameter]
    public Poll Poll { get; set; }
    [Parameter]
    public PaginatedWrapperDto<List<Comment>> Comments { get; set; }
    [Parameter]
    public EventCallback<int> OnPageChanged { get; set; }

    public Comment Comment { get; set; } = new Comment();
    private bool IsLoading { get; set; } = false;

    private int _page = 1;

    private async Task SubmitComment()
    {
        var authenticatedUser = await UserService.GetAuthenticatedUser();

        if (authenticatedUser != null)
        {
            Comment.Author = authenticatedUser;
            Comment.Poll = Poll;

            var createdComment = await CommentsService.Create(Comment);

            if (createdComment != null)
            {
                Comment.Content = String.Empty;
                Poll.Comments.Add(createdComment);

                await JS.InvokeAsync<string>("scrollToBottom");
            }
        }
    }

    private void NotifyParentPageChanged()
    {
        OnPageChanged.InvokeAsync(_page);
    }
}